'use strict';

var P = require('bluebird');
var request = require('superagent');
var ServiceUrlGetter = require('./service-url-getter');
var errorMessages = require('../utils/error-messages');
var VError = require('verror');

function ForestServerRequester() {
  this.perform = function (route, environmentSecret) {
    var urlService = new ServiceUrlGetter().perform();

    return new P(function (resolve, reject) {
      request.get(urlService + route).set('forest-secret-key', environmentSecret).end(function (error, result) {
        if (error) {
          return reject(new VError(error, 'Forest server request error'));
        }

        if (result.status === 200 && result.body) {
          return resolve(result.body);
        } else {
          if (result.status === 0) {
            return reject(new Error(errorMessages.SERVER_TRANSACTION.SERVER_DOWN));
          } else if (result.status === 404 || result.status === 422) {
            return reject(new Error(errorMessages.SERVER_TRANSACTION.SECRET_NOT_FOUND));
          } else {
            return reject(new Error(errorMessages.SERVER_TRANSACTION.UNEXPECTED, error));
          }
        }
      });
    });
  };
}

module.exports = ForestServerRequester;